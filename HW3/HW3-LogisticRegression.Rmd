---
title: "HW3-LogisticRegression"
author: "Richard Barad, Dave Drennan, Jarred Randall"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
install.packages("aod")
install.packages("ggplot2")
install.packages("rms")
install.packages("gmodels")
install.packages("nnet")
install.packages("DAAG")
install.packages("ROCR")
install.packages("xtable")

library(aod)
library(ggplot2)
library(rms)
library(gmodels)
library(nnet)
library(DAAG)
library(ROCR)
library(knitr)
library(kableExtra)
library(xtable)
library(dplyr)
library(crosstable)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
data <- read.csv("./Data/LogisticRegressionData.csv")

```

## Proportion of Crashes Involving a Drinking Driver

```{r}

DRINKING_D.tab <- table(data$DRINKING_D)
prop.table(DRINKING_D.tab)

kable(prop.table(DRINKING_D.tab), col.names = c("Drinking Driver", "Proportion"), 
      caption = "Proportion of Crashes Involving a Drinking Driver") %>%
  kable_styling(c("striped"), full_width = T, position = "left", font_size = 12)
  

```



## cross-tabulation between our dependent variable and binary predictors -  need to figure out the best way to make the table he is asking for

```{r warning=FALSE, message=FALSE, cache=FALSE}

# We need to figure out the best way to make the table he is asking for

ct1 <- CrossTable(data$DRINKING_D, data$FATAL_OR_M, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct2 <- CrossTable(data$DRINKING_D, data$OVERTURNED, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct3 <- CrossTable(data$DRINKING_D, data$CELL_PHONE, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct4 <- CrossTable(data$DRINKING_D, data$SPEEDING, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct5 <- CrossTable(data$DRINKING_D, data$AGGRESSIVE, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct6 <- CrossTable(data$DRINKING_D, data$DRIVER1617, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)

ct7 <- CrossTable(data$DRINKING_D, data$DRIVER65PLUS, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE)


table <- rbind(ct1, ct2, ct3, ct4, ct5, ct6, ct7)


```

## Chi-Square Test


```{r}

CrossTable(data$FATAL_OR_M, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$OVERTURNED, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$CELL_PHONE, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$SPEEDING, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$AGGRESSIVE, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$DRIVER1617, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
CrossTable(data$DRIVER65PLUS, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
    
```

```{r logit model}

logit = glm(formula = DRINKING_D ~ OVERTURNED + CELL_PHONE + SPEEDING + AGGRESSIVE + DRIVER1617 + DRIVER65PLUS + PCTBACHMOR + MEDHHINC, data = data, family = "binomial")

summary(logit)

exp(cbind(OR = coef(logit), confint(logit)))

logitoutput <- summary(logit)

logitcoeffs <- logitoutput$coefficients
logitcoeffs

or_ci <- exp(cbind(OR=coef(logit), confint(logit)))

finallogitoutput <- cbind(logitcoeffs, or_ci)
finallogitoutput

```
```{r warning=FALSE, message=FALSE, cache=FALSE}
fit <- logit$fitted       #Getting the y-hats (i.e., predicted values)
hist(fit)       #Histogram of fitted values
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
fit.binary = (fit>=0.02)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.03)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.05)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.07)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.08)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.09)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.1)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.15)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.2)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

fit.binary = (fit>=0.5)
CrossTable(fit.binary, data$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.c=FALSE, prop.chisq=FALSE)

```

## ROC Curve

```{r warning=FALSE, message=FALSE, cache=FALSE}
a <- cbind(data$DRINKING_D, fit)
head(a)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
colnames(a) <- c("labels","predictions")
head(a)
roc <- as.data.frame(a)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
pred <- prediction(roc$predictions, roc$labels)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
roc.perf = performance(pred, measure = "tpr", x.measure="fpr")
plot(roc.perf)
abline(a=0,b=1)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
opt.cut = function(perf, pred){
  cut.ind = mapply(FUN=function(x, y, p){
    d = (x - 0)^2 + (y-1)^2
    ind = which(d == min(d))
    c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
      cutoff = p[[ind]])
  }, perf@x.values, perf@y.values, pred@cutoffs)
}

print(opt.cut(roc.perf, pred))
```


```{r warning=FALSE, message=FALSE, cache=FALSE}
auc.perf = performance(pred, measure ="auc")
auc.perf@y.values
```

```{r logit model2}

logit2 = glm(formula = DRINKING_D ~ OVERTURNED + CELL_PHONE + SPEEDING + AGGRESSIVE + DRIVER1617 + DRIVER65PLUS, data = data, family = "binomial")

summary(logit2)

exp(cbind(OR = coef(logit2), confint(logit2)))

logitoutput2 <- summary(logit2)

logitcoeffs2 <- logitoutput2$coefficients
logitcoeffs2

or_ci2 <- exp(cbind(OR=coef(logit2), confint(logit2)))

finallogitoutput2 <- cbind(logitcoeffs2, or_ci2)
finallogitoutput2

```

```{r AIC}

AIC(logit, logit2)

```
