---
title: "Homework 2 - Spatial Regression"
author: "Richard Barad, Jarred Randall, Dave Drennan"
output: pdf_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r import_libraries}
library(sf)
library(tidyverse)
library(kableExtra)
library(spatialreg)
library(spdep)
library(gridExtra)
library(whitestrap)
library(lmtest)
library(tseries)
library(spgwr)
```

```{r read_data echo=FALSE}

data <- st_read('./Data/RegressionData.shp')

```

# Spatial Autocorrelation

## Global Moran's I

Map of dependent variable

``` {r dependent_variable_map}

ggplot()+
  geom_sf(data=data,aes(fill=LNMEDHVAL))+
  scale_fill_viridis_c(option='rocket',direction=-1)+
  theme_void()+
  theme(panel.background = element_rect(fill='white'),
        legend.position = c(0.8, 0.2))
```

Get queen neighbors for each census block group

```{r queen_neighboors, results='hide'}

queen<-spdep::poly2nb(data, row.names=data$POLY_ID)
summary(queen)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}

queenlist<-nb2listw(queen, style = 'W')

moranMC<-moran.mc(data$LNMEDHVAL, queenlist, nsim=999, alternative="two.sided")  #We use 999 permutations

#Draws distribution of Moran's I's calculated from randomly permuted values
# Here, we draw a red vertical line at the observed value of our Moran's I

ggplot()+
  geom_histogram(aes(moranMC$res),binwidth = 0.005)+
  xlim(-1,1)+
  geom_vline(xintercept=moranMC$statistic,color='red',linewidth=1)+
  labs(x="Moran's I value")+
  theme_bw()

```

This is ugly, we can try to do it in ggplot latter if we have time!! I am also not sure if we need this based on the directions. It was in r markdown, but might not be needed. Let me know what you think!

```{r MoransIplot}
moran.plot(data$LNMEDHVAL, queenlist,labels=FALSE) 
```

## Local Moran's I

```{r localmoransI}
#Run local moran's I (LISA) 

LISA<-localmoran(data$LNMEDHVAL, queenlist)
data_LISA <-cbind(data, as.data.frame(LISA))

quadrant<-vector(mode='numeric', length=323)
m.prop<-data$LNMEDHVAL - mean(data$LNMEDHVAL)
m.local<-LISA[,1]-mean(LISA[,1])
quadrant[m.prop >0 & m.local>0]<-'4' #high MEDHHINC, high clustering
quadrant[m.prop <0 & m.local<0]<-'1' #low MEDHHINC, low clustering
quadrant[m.prop <0 & m.local>0]<-'2' #low MEDHINC, high clustering
quadrant[m.prop >0 & m.local<0]<-'3' #high MEDHHINC, low clustering
quadrant[LISA[,5]>0.05]<-0

data_LISA <-cbind(data, as.data.frame(LISA), as.data.frame(quadrant))
```


```{r Morans_I_map warning=FALSE, message=FALSE, cache=FALSE}
grid.arrange(ncol=2,
             
ggplot()+
  geom_sf(data=data_LISA,aes(fill=quadrant))+
  scale_fill_manual(values=c('grey80','lightblue','blue','pink','red'),
                    labels=c("Insignificant","Low-High","Low-Low","High-Low","High-High"),
                    name='Significant Cluster')+
  theme_void()+
  theme(panel.background = element_rect(fill='white'),
        legend.position = c(0.8, 0.2)),

ggplot()+
  geom_sf(data=data_LISA,aes(fill = cut(Pr.z....E.Ii.., breaks = c(0,0.01,0.05,0.5,1))))+
  scale_fill_manual(values = c('#990000','#ef6548','#fdbb84','#fef0d9'),
                    labels=c('0 - 0.01','0.01 - 0.05','0.05 - 0.5','0.5 - 1'),
                    name='p-score')+
  theme_void()+
  theme(panel.background = element_rect(fill='white'),
        legend.position = c(0.8, 0.2))
)
```

# A Review of OLS Regression and Assumptions: 

## Results	

```{r ols_regression}

reg <-lm(LNMEDHVAL ~  PCTVACANT + PCTSINGLES + PCTBACHMOR + LNNBELPOV, data=data)

summary(reg)
```

## Heteroscedasticity tests

```{r hetersecadsticity tests}
#Prints the results of the Breusch-Pagan Test to assess whether heteroscedasticity is present (package: lmtest)
bptest(reg, studentize=FALSE)
#Prints the results of the Koenker-Bassett Test (also known as the Studentized Breusch-Pagan Test) to assess whether heteroscedasticity is present (package: lmtest)
bptest(reg)       
#Prints the results of the White Test to assess whether heteroscedasticity is present (package: whitestrap)
white_test(reg)
```

```{r scatter_plot}

data <- data %>%
  mutate(predictions = predict(reg,data),
        residual = LNMEDHVAL - predictions,
        stdres = rstandard(reg))

ggplot()+
  geom_point(data=data,aes(x=predictions,y=stdres),size=0.4
             )+
  labs(x='Predicted Values',y='Standardized Residuals')+
  ggtitle('Predicted Values vs. Standardized Residuals')+
  theme_bw()

```

## normality of errors (Jarque-Bera test)

``` {r jarque_bera_test}
#Prints the results of the Jarque-Bera Test to assess whether residuals are normal (package: tseries)
jarque.bera.test(data$residual)
```

``` {r histogram}

ggplot()+
  geom_histogram(data=data,aes(x=stdres),bins=100,color='white',fill='grey50')+
  labs(x='Standardized residual')+
  theme_bw()

```

# Spatial Lag Regression

```{r warning=FALSE, message=FALSE, cache=FALSE}
lagreg<-lagsarlm(formula=LNMEDHVAL ~ LNNBELPOV + PCTBACHMOR + PCTSINGLES + PCTVACANT, data=data, queenlist)
summary(lagreg)
LR.Sarlm(lagreg, reg) #Here lagreg is the SL output; reg is the OLS output
#Prints the results of the Breusch-Pagan Test to assess whether heteroscedasticity is present (package: lmtest)
bptest.Sarlm(lagreg, studentize=FALSE)
#Prints the results of the Koenker-Bassett Test (also known as the Studentized Breusch-Pagan Test) to assess whether heteroscedasticity is present (package: lmtest)
bptest.Sarlm(lagreg)       
#Prints the results of the Jarque-Bera Test to assess whether residuals are normal (package: tseries)
jarque.bera.test(lagreg$residuals)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
reslag<-lagreg$residuals
lagMoranMc<-moran.mc(reslag, queenlist,999, alternative="two.sided")
lagMoranMc
```

# Spatial Error Regression

```{r warning=FALSE, message=FALSE, cache=FALSE}
errreg<-errorsarlm(formula=LNMEDHVAL ~ LNNBELPOV + PCTBACHMOR + PCTSINGLES + PCTVACANT, data=data, queenlist)
reserr<-residuals(errreg)
errresnb<-sapply(queen, function(x) mean(reserr[x]))
summary(errreg)
LR.Sarlm(errreg, reg)
#Prints the results of the Breusch-Pagan Test to assess whether heteroscedasticity is present (package: lmtest)
bptest.Sarlm(errreg, studentize=FALSE)
#Prints the results of the Koenker-Bassett Test (also known as the Studentized Breusch-Pagan Test) to assess whether heteroscedasticity is present (package: lmtest)
bptest.Sarlm(errreg)       
#Prints the results of the Jarque-Bera Test to assess whether residuals are normal (package: tseries)
jarque.bera.test(errreg$residuals)
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
errMoranMc<-moran.mc(reserr, queenlist, 999, alternative="two.sided")
errMoranMc
```

# GWR

```{r warning=FALSE, message=FALSE, cache=FALSE}
#Setting an adaptive bandwidth
datas <- as(data, 'Spatial')  #These analyses are easier to do when the data are of the SpatialPolygonsDataFrame class
class (datas)
bw<-gwr.sel(formula=LNMEDHVAL ~ LNNBELPOV + PCTBACHMOR + PCTSINGLES + PCTVACANT, 
            data=datas,
            method = "aic",
            adapt = TRUE)
bw
```

```{r warning=FALSE, message=FALSE, cache=FALSE}
gwrmodel<-gwr(formula=LNMEDHVAL ~ LNNBELPOV + PCTBACHMOR + PCTSINGLES + PCTVACANT,
              data=datas,
              adapt = bw, #adaptive bandwidth determined by proportion of observations accounted for
              gweight=gwr.Gauss,
              se.fit=TRUE, #to return local standard errors
              hatmatrix = TRUE)
gwrmodel

```